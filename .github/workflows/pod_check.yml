name: Check pods
on: [push]
  #workflow_dispatch:
jobs:
  pods:
    runs-on: ubuntu-latest
    
    steps:

      - name: SSH connect to remoute host
        id: kube_pod
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          proxy_host: ${{ secrets.PROXY_HOST }}
          proxy_username: ${{ secrets.PROXY_USERNAME }}
          proxy_key: ${{ secrets.PROXY_KEY }}
          proxy_port: ${{ secrets.PROXY_PORT }} #-v          
          script: |
            kubectl get pods -A --context="k8s" | grep -E 'Running|Completed' > k8s.log   
            echo "::set-output name={k8s_log}::{$(cat k8s.log)}"
            echo "::set-output name={k8s_count}::{$(cat k8s.log | wc -l)}"
            echo "{k8s_log2}={$(cat k8s.log)}" >> $GITHUB_OUTPUT
            echo "GOOD!"  
            
      - name: Download file via SSH
        uses: nicklasfrahm/scp-action@main
        with:
          direction: download
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          insecure_ignore_fingerprint: true
          port: ${{ secrets.PORT }}
          proxy_host: ${{ secrets.PROXY_HOST }}
          proxy_fingerprint: true
          proxy_username: ${{ secrets.PROXY_USERNAME }}
          proxy_key: ${{ secrets.PROXY_KEY }}
          proxy_port: ${{ secrets.PROXY_PORT }}
          insecure_proxy_ignore_fingerprint: true
          source: "/root/k8s.log"
          target: "./k8s.log"

      - name: copy file via ssh 
        run: cat ./k8s.log
        shell: bash
   

       